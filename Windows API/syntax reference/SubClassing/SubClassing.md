# SubClassing
  
**서브클래싱(SubClassing)이란 윈도우 프로시저로 전달되는 메시지를 중간에 가로채는 기법**이다. 중간에서 메시지를 가로챔으로써 특정 메시지에 대한 동작을 사용자가 특별히 정의할 수 있다.  
  
윈도우 프로시저로 전달되는 메시지를 가로채서 기존과는 다른 동작을 하기 위해서는 기존 윈도우 프로시저와는 다른 새로운 윈도우 프로시저가 필요하다. 이때 만들어지는 새로운 윈도우 프로시저를 서브클래스 프로시저(Subclass Procedure)라고 한다.  
  
방법은 윈도우 클래스에 등록되어 있던 윈도우 프로시저의 번지(lpfnWndProc)를 새로 만들어진 서브클래스 프로시저의 번지로 변경함으로써 우선적으로 서브클래스 프로시저에 메시지가 전달되도록 하는 것이다. 이때 주의할 점은 서브클래싱에서 처리하지 않는 메시지는 기존의 윈도우 프로시저로 보내기 위해 기존의 윈도우 프로시저의 번지를 보관해야 한다는 점이다.  
  
## 종류
  
서브클래싱은 시점과 방법, 효과에 따라 크게 두 가지로 분류된다.  
  
- 인스턴스 서브클래싱 : **윈도우가 만들어진 후 그 윈도우 하나에 대해서만 윈도우 프로시저를 교체하는 것**으로 이후에 만들어지는 윈도우는 영향을 받지 않는다. SetWindowLongPtr 함수를 사용한다.  
  
- 전역 서브클래싱 : **윈도우 클래스에 대해 서브클래싱을 하는 것**으로 WNDCLASS 구조체를 직접 변경하기 때문에 변경 이후 만들어진 윈도우에만 영향이 있다. SetClassLongPtr 함수를 사용한다.
  
## 처리 방법
  
서브클래싱을 활용하여 메시지를 처리하는 경우 보편적으로 다음 세 가지 유형으로 나눌 수 있다.  
  
1. 자신이 처리하지 않는 메시지는 기존의 윈도우 프로시저로 보낸다.  
  
2. 자신이 처리하고자 하는 메시지가 왔을 경우, 기존과는 다른 방법으로 처리한다.  
  
3. 메시지에 전달되는 정보를 변경하여 기존의 윈도우 프로시저로 보낸다. 예를 들어, 메시지마다 가지고 있는 고유의 wParam, lParam의 정보를 변경하여 기존의 윈도우 프로시저로 보내 원하는 결과를 얻을 수 있도록 유도한다.  
  
## 인스턴스 서브클래싱 사용 방법
  
1. 기존의 윈도우 프로시저의 번지를 기억할 변수를 선언한다. 실행 중 변경되면 안 되고 서브클래스 프로시저에서도 사용해야 하기 때문에 전역변수로 선언한다.  
  
        WNDPROC OldWndProc;
  
2. 서브클래싱에 사용하기 위한 서브클래스 프로시저를 정의한다. (물론 선언과 정의를 따로해도 상관없다.)  
      
        LRESULT CALLBACK SubWndProc(HWND hWnd, UINT iMessage, WPARAM wParam, LPARAM lParam)
        {
            // 처리
            return (CallWindowProc(OldEditProc, hWnd, iMessage, wParam, lParam));
        }
  
    서브클래스 프로시저를 정의할 때는 모든 처리를 마친 후 반드시 CallWindowProc을 호출해야 한다. 자신이 처리하지 않은 메시지는 기존의 윈도우 프로시저로 보내야 하기 때문이다. 첫 인수는 기존의 윈도우 프로시저의 번지이고 나머지는 윈도우 프로시저의 인수 순서대로 전달해주면 된다.  
  
3. 기존의 윈도우 프로시저에서 윈도우 클래스의 멤버 lpfnWndProc 값을 서브클래스 프로시저의 번지로 변경한다. 우선 WM_CREATE에서 처리한다고 가정하자.  
  
        case WM_CREATE:
            OldWndProc = (HWNDPROC)SetWindowLongPtr(hWnd, GWLP_WNDPROC, (LONG_PTR)SubWndProc);
            return 0;
  
    64비트와의 이식성을 위해 반드시 SetWindowLongPtr 함수를 사용하여 변경해야 한다. 기본적으로 다음과 같은 형태로 변경하면 된다.  
  
        기존 윈도우 프로시저의 번지를 기억할 변수 = SetWindowLongPtr(서브클래싱할 윈도우,
            GWLP_WNDPROC, (LONG_PTR)서브클래스 프로시저 이름);
  
## 전역 서브클래싱 사용 방법
  
인스턴스 서브클래싱의 1번과 2번까지는 동일하다. 단지, 3번에서 변경하는 함수가 살짝 달라질 뿐이다.  
  
	case WM_CREATE:
		OldWndProc = (HWNDPROC)SetClassLongPtr(hWnd, GCLP_WNDPROC, (LONG_PTR)SubWndProc);
  
이게 다다. 전역 서브클래싱은 윈도우 클래스 자체를 바꾸는 것이기 때문에 다른 프로세스에는 영향을 주지 못한다.  
## 주의사항
  
원래 서브클래싱은 꼭 필요하지 않는 한 사용하지 않는 것이 좋다. 확실히 유용하고 편리한 기법이긴 하지만 그만큼 리스크도 따르기 때문이다. 꼭 사용해야 하는 상황이라면 다음의 주의사항을 꼭 숙지해야 한다.  
  
1. 윈도우의 원래 기능을 보존해야 한다. 있는 기능을 빼버리거나 처리를 완전히 바꿔버리는 등 너무 원래 기능을 훼손하는 것은 좋지 않다. C++의 연산자 오버로딩과 비슷하다고 보면 된다.  
  
2. 서브클래스 프로시저는 어떠한 일이 있어도 여분메모리(cbWndExtra, cbClsExtra)를 건드려서는 안 된다. 여분 메모리는 그 클래스를 만든 사람이 특수한 목적을 위해 할당한 것이므로 해당 클래스의 제작자가 아닌 이상 알 수 없으므로 함부러 건드려서는 안 된다. 용도를 알고 있더라도 해당 메모리는 성능 향상을 위해 언제든 변경될 수 있으므로 건드리는 것은 옳지 않다.  
  
서브클래싱한 윈도우에서 여분 메모리가 꼭 필요하다면 윈도우 프로퍼티를 사용하는 것이 좋다.
