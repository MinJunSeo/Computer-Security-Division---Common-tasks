# PM2
  
## Package Manager
  
패키지라는 말은 소프트웨어를 부르는 여러 말 중 하나이다. 독립적으로 실행되는 프로그램이나 부품으로 사용되는 작은 프로그램도 패키지라고 할 수 있다.  
  
패키지 매니저란 그런 패키지들을 생성, 설치, 업데이트, 삭제 등을 관리해주는 프로그램을 말한다.  
  
Node.js에서 가장 광범위하게 사용되고 있는 패키지 매니저는 **NPM**이다. 기본적으로 Node.js를 설치할 때 같이 설치된다.  
  
## PM2
  
PM2는 production process manager for Node.js라고 소개되는데, 해석하면 Node.js에서 실행되는 프로그램을 보조하는 매니저 제품이라고 볼 수 있다.  
  
CMD 창에서 Node.js 프로그램을 실행하다 보면 원하지 않는 타이밍에 CMD 창이 꺼질 때가 있다. 그럴 때마다 새로 켜서 다시 새로 서버를 열어야 하는데, PM2는 우리가 실행 시킨 프로그램의 내용을 기억하다가 꺼지면 다시 켜주는 역할을 해준다.  
  
또한 코드를 수정하고나면 다시 CMD를 껐다 켜야 하는데, PM2는 소스가 수정되는지 계속 주시하고 있다가 코드가 수정되면 자동으로 껐다 켜주는 역할도 해준다.  
  
Node.js로 만들어진 프로그램들은 npm을 통해 인터넷으로 쉽게 설치할 수 있다. PM2의 페이지에 들어가면 메인 페이지에 `npm install pm2 -g` 명령어가 적혀 있는 것을 볼 수 있다.  
  
`npm install pm2 -g` 명령어에서 `install`은 뒤에 있는 `pm2`라는 프로그램을 설치한다는 뜻이다. `-g`는 설치하는 프로그램이 독립된 프로그램이여서 해당 컴퓨터 어디에서도 사용할 수 있어야 한다는 뜻이다.  
  
### pm2로 node.js 프로그램 실행시키기
  
설치가 끝난 후 pm2를 실행시키고자 한다면 `pm2 start app.js` 명령어를 입력하면 된다. 이때 app은 자신이 실행시키고자 하는 파일명을 입력하면 된다.  
  
실행시키면 다음과 같은 표가 나타나게 된다. (시간이 조금 걸릴 수 있다.)  
![PM2](https://user-images.githubusercontent.com/51042546/79287291-4f924380-7efe-11ea-9176-f1f8f89334ac.JPG)  
  
name은 현재 실행시키고 있는 프로그램의 이름이며, status가 online이면 현재 실행 중임을 의미한다. 또한 cpu나 memory를 얼마나 소모하고 있는지도 보여준다.  
  
### 현재 pm2로 실행 중인 프로세스 보기
  
이 창을 실행 중에 다시 보고 싶다면 `pm2 list` 명령어를 입력하면 다시 볼 수 있다.  
  
`pm2 monit` 명령어를 입력하면 현재 pm2에 의해 실행 중인 프로그램들을 한 번에 보여준다.  
![monit](https://user-images.githubusercontent.com/51042546/79287564-21f9ca00-7eff-11ea-9c51-b9becd3fca38.JPG)  
  
monit는 현재 실행 중인 파일(프로그램)이 종료되면 곧바로 반응하여 종료되었음을 창에 표시해준다. 또한 저 화면에서 `Q` 버튼을 누르면 나갈 수 있다.  
  
### 프로세스 종료시키기
  
실행 중인 프로그램을 종료하고 싶다면 `pm2 stop name` 명령어를 입력하면 status가 `stopped`가 된다. 이때 name은 `pm2 list` 명령어를 통해 볼 수 있는 리스트의 name에 적혀 있는 프로그램 이름을 말한다.  
  
소스 코드가 수정될 때마다 자동으로 껐다 켜주는 기능을 활성화하기 위해서는 `pm2 start app.js --watch` 명령어를 입력하면 된다.(물론 app은 실행시키고자 하는 프로그램 이름이다.)  
  
단, 이 명령어를 실행시키면 파일에서 에러가 있을 때 그 에러를 화면에 바로 보여주지 않는다. 이 문제를 해결하기 위해서는 `pm2 log`를 입력하면 코드를 수정했을 때 수정된 부분이나 에러를 화면에 보여주게 된다.  
  
`pm2 kill` 명령어를 입력하면 pm2를 사용하여 실행 중인 모든 프로세스를 모두 끌 수 있다.  
  
### pm2 실행시키면서 log도 확인하기
  
`pm2 start app.js --watch --no-daemon`을 입력하면 프로그램이 실행된다. 이때 --no-daemon 옵션을 추가로 주었는데 이것은 daemon이 아니라는 뜻이다. daemon은 백그라운드에서 실행되고 있는 프로그램들을 말한다. 이렇게 하면 pm2를 실행시킴과 동시에 console.log의 출력 등 log까지 볼 수 있게 된다. 이 상태에서 나가기 위해서는 `Ctrl + C`를 하면 된다. 그런데 이게 가끔가다 꺼지지 않을 때도 있다.  
  
그런데 이 실행 방법의 문제점은 웹 페이지에서 뭔가의 변경이 일어나면 프로그램이 한 번 꺼졌다가 다시 켜지게 된다. 이 상황은 자칫하면 원하지 않는 타이밍에 프로그램이 꺼졌다가 다시 켜질 수 있다는 것이다. 또한 프로그램이 한 번 꺼졌다가 다시 켜지게 되면 우리가 메모리에 세팅해 둔 데이터가 모드 삭제된다.  
  
## pm2 프로그램의 재가동 문제 해결하기
  
이 문제를 해결하기 위해서는 `pm2 start app.js --watch --ignore-watch="무시하고자 하는 정보의 경로" --no-daemon`을 입력하면 된다. 이렇게 하면 지정된 경로에 파일 생성, 변경, 삭제 되더라도 프로그램이 꺼졌다가 다시 실행되지 않는다. 물론 특정 파일에 대해서만 설정할 수도 있고 디렉토리 안에 있는 모든 파일에 대해서도 지정할 수 있다.  
  
여러 개의 디렉토리를 관리해야 한다면 "" 안에서 경로를 지정할 때 띄어쓰기를 통해 복수 개의 디렉토리 경로를 지정할 수 있다.  
